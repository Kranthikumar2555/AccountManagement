@model AccountManagement.Models.FirstTimeLoginViewModel
@{
    ViewData["Title"] = "First Time Login";
}
@{
    Layout = "~/Views/Shared/_LoginLayout.cshtml";
}


<div class="form-container">
    <h2 class="text-center">Set New Password</h2>
    <form id="FirstTimeLoginRedirect">
        <input type="hidden" asp-for="EmployeeId" id="EmployeeId" value="@Model.EmployeeId" />

        <div class="form-group">
            <label for="Password" class="form-label">Password</label>
            <input asp-for="Password" id="Password" name="Password" class="form-control" type="password" />
            <span asp-validation-for="Password" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label for="ConfirmPassword" class="form-label">Confirm Password</label>
            <input asp-for="ConfirmPassword" id="ConfirmPassword" name="ConfirmPassword" class="form-control" type="password" />
            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-primary">Set Password</button>
        </div>
    </form>
    <div id="responseMessage" class="mt-3"></div>
</div>

@section scripts {

        
    <script>
    $(document).ready(function() {
        $("#FirstTimeLoginRedirect").validate({
            rules: {
                Password: {
                    required: true,
                    minlength: 6
                },
                ConfirmPassword: {
                    equalTo: "#Password",
                    minlength: 6
                }
            },
            messages: {
                Password: {
                    required: "Please enter your new password",
                    minlength: "Your password must be at least 6 characters long"
                },
                ConfirmPassword: {
                    equalTo: "Passwords do not match",
                    minlength: "Your password must be at least 6 characters long"
                }
            },
            errorElement: "span",
            errorClass: "text-danger",
            validClass: "is-valid",
            highlight: function(element, errorClass, validClass) {
                $(element).addClass(errorClass).removeClass(validClass);
            },
            unhighlight: function(element, errorClass, validClass) {
                $(element).removeClass(errorClass).addClass(validClass);
            }
        });

        // Handle form submission via AJAX
        $("#FirstTimeLoginRedirect").submit(function(event) {
            event.preventDefault(); 
            if ($(this).valid()) {
                var formData = {
                    EmployeeId: $("#EmployeeId").val(),
                    Password: $("#Password").val(),
                    ConfirmPassword: $("#ConfirmPassword").val()
                };

                $.ajax({
                    url: '@Url.Action("FirstTimeLogin1", "Login")',
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        $("#responseMessage").html('<div class="alert alert-success">Password set successfully!</div>');

                          window.location.href = '@Url.Action("EmployeeDashboard", "Employee", new { employeeId = Model.EmployeeId })';
                    },
                    error: function(xhr, status, error) {
                        $("#responseMessage").html('<div class="alert alert-danger">Error: ' + xhr.responseText + '</div>');
                    }
                });
            }
        });
    });
    </script>
}
